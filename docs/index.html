<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>IP和代理检测及定位</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    #info, #ipOnlyResult { white-space: pre-wrap; margin-top: 10px; }
    button { margin: 5px 0; }
  </style>
</head>
<body>
  <h1>简单实用的IP检测及定位功能</h1>
  <p id="info">请稍候，正在获取信息……</p>

  <button onclick="showIP()">点击显示当前公网IP</button>
  <p id="ipOnlyResult"></p>

  <button onclick="triggerLocation()">点击获取定位及提交数据</button>

  <button onclick="openBilibili()">打开哔哩哔哩视频</button>
  <button onclick="openYouTube()">打开YouTube视频</button>

  <script>
    // Google表单的字段名，请改成你的实际字段ID
    const entryIPProxy = "entry.349181765";  
    const entryLon = "entry.1434358418";
    const entryLat = "entry.99996352";

    // 你墙内的中转接口地址
    const submitUrl = "/submit";

    // 获取IP用ip.sb，避免被墙
    async function getIP() {
      try {
        const res = await fetch('https://api.ip.sb/ip');
        const ip = (await res.text()).trim();
        return ip;
      } catch (e) {
        return "获取失败";
      }
    }

    // 读取json判断是否代理IP（ip_country_ranges.json需要在你服务器同目录）
    async function isProxyIP(ip) {
      const ipNum = ip.split('.').reduce((acc, val) => acc * 256 + Number(val), 0);
      const response = await fetch('ip_country_ranges.json');
      const data = await response.json();

      for (const [start, end, country] of data) {
        if (ipNum >= start && ipNum <= end) {
          // 这里你可以根据country判断，比如排除中国的IP就算代理
          return country !== "CN";  // 假设非中国IP视为代理
        }
      }
      return false;
    }

    // 显示公网IP按钮
    async function showIP() {
      const output = document.getElementById('ipOnlyResult');
      output.textContent = "查询中……";
      const ip = await getIP();
      output.textContent = "当前公网 IP 是：" + ip;
    }

    // 主逻辑：获取IP，定位，经纬度，检测代理，提交数据
    async function triggerLocation() {
      const info = document.getElementById('info');
      info.textContent = "获取IP中……";
      const ip = await getIP();
      info.textContent = `IP: ${ip}`;

      const proxy = await isProxyIP(ip);
      info.textContent += `\n是否代理IP: ${proxy ? "是" : "否"}`;

      if (!navigator.geolocation) {
        info.textContent += "\n浏览器不支持定位功能";
        await submitData(ip, proxy, "不支持", "不支持");
        return;
      }

      info.textContent += "\n正在获取定位……";

      navigator.geolocation.getCurrentPosition(async (pos) => {
        const lat = pos.coords.latitude.toFixed(6);
        const lon = pos.coords.longitude.toFixed(6);
        info.textContent += `\n经度: ${lon}\n纬度: ${lat}`;
        await submitData(ip, proxy, lon, lat);
      }, async (err) => {
        info.textContent += `\n定位失败：${err.message}`;
        await submitData(ip, proxy, "失败", "失败");
      }, {timeout: 15000});
    }

    // 提交数据到你墙内服务器
    async function submitData(ip, proxy, lon, lat) {
      const ipProxyStr = `${ip} (${proxy ? "代理" : "非代理"})`;
      try {
        await fetch(submitUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: new URLSearchParams({
            [entryIPProxy]: ipProxyStr,
            [entryLon]: lon,
            [entryLat]: lat
          })
        });
        console.log("提交成功");
      } catch (e) {
        console.error("提交失败", e);
      }
    }

    // 打开哔哩哔哩视频
    function openBilibili() {
      window.open("https://www.bilibili.com/video/BV1GJ411x7h7/?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=7504f18c191405de66c8b613d77dfea9", "_blank");
    }

    // 打开YouTube视频
    function openYouTube() {
      window.open("https://www.youtube.com/watch?v=dQw4w9WgXcQ", "_blank");
    }
  </script>
</body>
</html>



